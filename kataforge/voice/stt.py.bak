from __future__ import annotations

import asyncio
import base64
import json
import logging
import os
from pathlib import Path
from typing import Any, Dict, List, Optional, Tuple

try:
    import httpx
    HTTPX_AVAILABLE = True
except ImportError:
    HTTPX_AVAILABLE = False
    httpx = None

try:
    import numpy as np
    NP_AVAILABLE = True
except ImportError:
    NP_AVAILABLE = False
    np = None

try:
    import scipy
    SCIPY_AVAILABLE = True
except ImportError:
    SCIPY_AVAILABLE = False
    scipy = None

from . import STTProvider, TTSProvider, VoiceIntent, IntentParser

logger = logging.getLogger(__name__)


class WhisperSTT(STTProvider):
    """Speech-to-Text using Whisper model."""
    
    def __init__(
        self,
        model_name: str = "base",
        device: str = "auto",
        language: str = "en",
    ):
        """Initialize Whisper STT.
        
        Args:
            model_name: Whisper model size (tiny, base, small, medium, large)
            device: Device to use (auto, cpu, cuda, rocm)
            language: Language code for recognition
        """
        self.model_name = model_name
        self.device = device
        self.language = language
        self.model = None
        self._initialized = False
        
    async def is_available(self) -> bool:
        """Check if Whisper is available."""
        if not NP_AVAILABLE:
            return False
        
        try:
            # Try to import whisper
            import whisper  # type: ignore
            return True
        except ImportError:
            return False
    
    async def get_languages(self) -> List[str]:
        """Get supported languages."""
        return [
            "en", "es", "fr", "de", "it", "ja", "ko", "zh", "ru", "ar", "tr", 
            "nl", "pl", "sv", "pt", "hi", "th", "vi", "id", "cs", "el", "hu"
        ]
    
    async def transcribe(self, audio: np.ndarray, sample_rate: int) -> str:
        """Transcribe audio to text using Whisper.
        
        Args:
            audio: Audio data as numpy array
            sample_rate: Audio sample rate
            
        Returns:
            Transcribed text
        """
        if not NP_AVAILABLE:
            raise RuntimeError("numpy is required for Whisper STT")
        
        try:
            import whisper  # type: ignore
            
            # Initialize model if not already done
            if not self._initialized:
                logger.info("Loading Whisper model: %s", self.model_name)
                self.model = whisper.load_model(self.model_name, device=self.device)
                self._initialized = True
            
            # Convert to 16kHz mono if needed
            if sample_rate != 16000:
                # Simple resampling (in production, use librosa or similar)
                if not SCIPY_AVAILABLE:
                    raise RuntimeError("scipy is required for resampling")
                audio = scipy.signal.resample(
                    audio, 
                    int(len(audio) * 16000 / sample_rate)
                )
                sample_rate = 16000
            
            # Ensure mono
            if len(audio.shape) > 1:
                audio = np.mean(audio, axis=1)
            
            # Transcribe
            result = self.model.transcribe(audio, language=self.language)
            return result["text"].strip()
            
        except Exception as e:
            logger.error("Whisper transcription failed", exc_info=e)
            raise RuntimeError(f"Whisper transcription failed: {e}")
    
    async def close(self):
        """Close the STT provider."""
        # Whisper doesn't have a close method, so we just set model to None
        self.model = None
        self._initialized = False